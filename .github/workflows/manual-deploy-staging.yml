name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'What to deploy'
        required: true
        type: choice
        options:
          - realm
          - registry
          - mundus
        default: realm
      commit:
        description: 'Commit SHA to deploy (leave empty for latest)'
        required: false
        default: ''
      mode:
        description: 'Deploy mode'
        required: false
        type: choice
        options:
          - upgrade
          - reinstall
        default: upgrade

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.commit || github.sha }}

      - name: Set deployment commit
        id: commit
        run: |
          DEPLOY_COMMIT="${{ github.event.inputs.commit || github.sha }}"
          echo "deploy_commit=$DEPLOY_COMMIT" >> $GITHUB_OUTPUT
          echo "Deploying commit: $DEPLOY_COMMIT"

      - name: Deploy to staging
        run: |
          # Store identity in a temporary file
          echo "${{ secrets.IC_IDENTITY_PEM }}" > identity.pem
          chmod 600 identity.pem
          
          # Pull the demo image (includes extensions)
          docker pull ghcr.io/${{ github.repository_owner }}/realms:demo-${{ steps.commit.outputs.deploy_commit }}
          
          # Build the deploy command based on target
          TARGET="${{ github.event.inputs.target }}"
          MODE="${{ github.event.inputs.mode }}"
          
          if [ "$TARGET" = "realm" ]; then
            # Single realm deployment
            if [ "$MODE" = "reinstall" ]; then
              DEPLOY_CMD="realms realm create --manifest examples/demo/realm1/manifest.json --random --network staging --deploy --mode reinstall"
            else
              DEPLOY_CMD="realms realm create --manifest examples/demo/realm1/manifest.json --network staging --deploy --mode upgrade"
            fi
          elif [ "$TARGET" = "registry" ]; then
            # Registry deployment - create and deploy
            DEPLOY_CMD="realms registry create --name 'Demo Registry' --output-dir .realms && realms registry deploy --folder .realms/registry --network staging --mode $MODE"
          elif [ "$TARGET" = "mundus" ]; then
            # Full mundus deployment - creates registry + all realms from manifest
            DEPLOY_CMD="realms mundus create --manifest examples/demo/manifest.json --network staging --deploy --mode $MODE"
          else
            echo "Unknown target: $TARGET"
            exit 1
          fi
          
          echo "ðŸš€ Deploying $TARGET with mode: $MODE"
          echo "ðŸ“‹ Command: $DEPLOY_CMD"
          
          # Deploy using realms CLI
          docker run --rm \
            -v "$(pwd)/identity.pem:/app/identity.pem" \
            -v "$(pwd)/deploy-logs:/app/deploy-logs" \
            -e DFX_WARNING="-mainnet_plaintext_identity" \
            ghcr.io/${{ github.repository_owner }}/realms:demo-${{ steps.commit.outputs.deploy_commit }} \
            bash -c "(dfx identity import my-identity /app/identity.pem --storage-mode=plaintext --force && \
                     dfx identity use my-identity && \
                     echo 'ðŸŽ¯ Target: $TARGET' && \
                     echo 'âš™ï¸  Mode: $MODE' && \
                     $DEPLOY_CMD); \
                     EXIT_CODE=\$?; \
                     mkdir -p /app/deploy-logs && \
                     cp -f dfx.log /app/deploy-logs/ 2>/dev/null || true && \
                     cp -f dfx2.log /app/deploy-logs/ 2>/dev/null || true && \
                     cp -f realms.log /app/deploy-logs/ 2>/dev/null || true; \
                     exit \$EXIT_CODE"
          
          # Clean up
          rm identity.pem
      
      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: force-deploy-logs
          path: deploy-logs/
          retention-days: 7
