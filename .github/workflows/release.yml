name: Create Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release (patch, minor, major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.PAT_GITHUB }}
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bumpversion semver build twine
      
      # Bump version
      - name: Bump version
        id: bump_version
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Create version file if it doesn't exist
          if [ ! -f "version.txt" ]; then
            echo "0.1.0" > version.txt
          fi
          
          # Calculate new version with Python
          CURRENT_VERSION=$(cat version.txt)
          NEW_VERSION=$(python -c "import semver; v=semver.VersionInfo.parse('${CURRENT_VERSION}'); print(v.bump_${{ github.event.inputs.release_type || 'patch' }}())")
          
          # Update version file
          echo "${NEW_VERSION}" > version.txt
          
          # Update CLI version
          sed -i "s/version = \".*\"/version = \"${NEW_VERSION}\"/" cli/pyproject.toml
          sed -i "s/__version__ = \".*\"/__version__ = \"${NEW_VERSION}\"/" cli/realms/__init__.py
          
          # Update default Docker image to use the new version tag
          sed -i "s|DEFAULT_DOCKER_IMAGE = \"ghcr.io/smart-social-contracts/realms:v.*\"|DEFAULT_DOCKER_IMAGE = \"ghcr.io/smart-social-contracts/realms:v${NEW_VERSION}\"|" cli/realms/cli/constants.py
          
          # Store new version for later use
          echo "NEW_VERSION=${NEW_VERSION}" >> $GITHUB_OUTPUT
      
      - name: Check if release already exists
        run: |
          TAG="v${{ steps.bump_version.outputs.NEW_VERSION }}"
          if gh release view "$TAG" &>/dev/null; then
            echo "‚ùå ERROR: Release $TAG already exists!"
            echo "If you want to create a new release, the version has already been bumped."
            echo "Either delete the existing release first, or trigger the workflow again to bump to the next version."
            exit 1
          fi
          echo "‚úÖ Release $TAG does not exist yet, proceeding..."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Pull and tag the Docker images
      - name: Pull and tag Docker images
        run: |
          mkdir -p release-logs
          
          # Pull the latest Docker image
          docker pull ghcr.io/${{ github.repository_owner }}/realms:latest 2>&1 | tee release-logs/docker-pull.log
          
          # Tag with version number
          docker tag ghcr.io/${{ github.repository_owner }}/realms:latest \
            ghcr.io/${{ github.repository_owner }}/realms:v${{ steps.bump_version.outputs.NEW_VERSION }} 2>&1 | tee -a release-logs/docker-tag.log
          
          # Push the versioned tag
          docker push ghcr.io/${{ github.repository_owner }}/realms:v${{ steps.bump_version.outputs.NEW_VERSION }} 2>&1 | tee release-logs/docker-push.log
          
          echo "‚úÖ Docker image tagged and pushed: v${{ steps.bump_version.outputs.NEW_VERSION }}" | tee -a release-logs/docker-push.log
      
      - name: Extract canister artifacts
        run: |
          # Create directory for artifacts
          mkdir -p artifacts

          # Build canisters and extract WASM/DID files
          docker run --rm \
            -v "$(pwd)/artifacts:/artifacts" \
            -v "$(pwd)/release-logs:/logs" \
            ghcr.io/${{ github.repository_owner }}/realms:latest \
            bash -c "realms realm create --bare --deploy && \
                    REALM_DIR=\$(ls -td .realms/realm_* | head -1) && \
                    echo \"üìÇ Found realm directory: \$REALM_DIR\" && \
                    cp \$REALM_DIR/.dfx/local/canisters/realm_backend/realm_backend.wasm.gz /artifacts/ && \
                    cp \$REALM_DIR/.dfx/local/canisters/realm_backend/service.did /artifacts/realm_backend.did && \
                    cp -f \$REALM_DIR/dfx.log /logs/canister-extraction-dfx.log 2>/dev/null || true && \
                    cp -f \$REALM_DIR/realms.log /logs/canister-extraction-cli.log 2>/dev/null || true"
          
          # Move artifacts to root for release
          mv artifacts/realm_backend.wasm.gz ./
          mv artifacts/realm_backend.did ./
          
          echo "‚úÖ Canister artifacts extracted" | tee -a release-logs/canister-extraction.log
      
      - name: Build and publish CLI to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd cli
          
          # Verify version consistency
          PYPROJECT_VERSION=$(grep -Po '^version = "\K[^"]*' pyproject.toml)
          INIT_VERSION=$(grep -Po '(?<=__version__ = ")[^"]*' realms/__init__.py)
          
          echo "Version in pyproject.toml: $PYPROJECT_VERSION" | tee -a ../release-logs/pypi-publish.log
          echo "Version in __init__.py: $INIT_VERSION" | tee -a ../release-logs/pypi-publish.log
          
          if [ "$PYPROJECT_VERSION" != "$INIT_VERSION" ]; then
            echo "ERROR: Version mismatch" | tee -a ../release-logs/pypi-publish.log
            exit 1
          fi
          
          # Build and publish
          python -m build 2>&1 | tee -a ../release-logs/pypi-build.log
          twine check dist/* 2>&1 | tee -a ../release-logs/pypi-check.log
          twine upload dist/* 2>&1 | tee -a ../release-logs/pypi-upload.log
          
          echo "‚úÖ CLI published to PyPI: v${{ steps.bump_version.outputs.NEW_VERSION }}" | tee -a ../release-logs/pypi-publish.log
      
      # Commit version changes (tag will be created by release action)
      - name: Commit and push version changes
        run: |
          git add version.txt cli/pyproject.toml cli/realms/__init__.py cli/realms/cli/constants.py 2>&1 | tee release-logs/git-add.log
          git commit -m "Bump version to ${{ steps.bump_version.outputs.NEW_VERSION }}" 2>&1 | tee release-logs/git-commit.log
          git remote set-url origin https://${{ secrets.PAT_GITHUB }}@github.com/${{ github.repository }}.git
          git push origin 2>&1 | tee release-logs/git-push.log
          
          echo "‚úÖ Version changes committed and pushed" | tee -a release-logs/git-push.log
      
      - name: Upload release logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-logs
          path: release-logs/
          retention-days: 7
      
      # Create GitHub release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump_version.outputs.NEW_VERSION }}
          name: Release v${{ steps.bump_version.outputs.NEW_VERSION }}
          generate_release_notes: true
          fail_on_unmatched_files: true
          files: |
            realm_backend.wasm.gz
            realm_backend.did
          body: |
            This release includes:
            
            ## üì¶ Release Assets
            
            ### üê≥ Docker Image
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/realms:v${{ steps.bump_version.outputs.NEW_VERSION }}
            # or use :latest for the most recent release
            docker pull ghcr.io/${{ github.repository_owner }}/realms:latest
            ```
            
            ### üîß Canister Artifacts (WASM + DID)
            - `realm_backend.wasm.gz` + `realm_backend.did` - Main realm backend canister
            
            ### üì¶ CLI Tool (PyPI)
            ```bash
            pip install --upgrade realms-gos==${{ steps.bump_version.outputs.NEW_VERSION }}
            ```
            
            ### üìÅ Source Code
            - Source code (zip)
            - Source code (tar.gz)
            
            ## Installation
            
            **Deploy Canisters:**
            ```bash
            # Download the .wasm.gz and .did files
            dfx deploy --network ic
            ```
            
            **Run Docker Image:**
            ```bash
            docker run -it ghcr.io/${{ github.repository_owner }}/realms:v${{ steps.bump_version.outputs.NEW_VERSION }}
            ```
            
            **Install CLI:**
            ```bash
            pip install realms-gos==${{ steps.bump_version.outputs.NEW_VERSION }}
            ```
            
            ## Commit
            ${{ github.sha }}
